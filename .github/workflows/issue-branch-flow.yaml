name: Branch From Issue ğŸ›ğŸŒ¿

on:
  issues:
    types: [assigned, closed]

jobs:
  create-branch:
    runs-on: ubuntu-latest
    # run if issue was labeled or created
    if: github.event_name == 'issues' && github.event.action == 'assigned'
    steps:

      # checkout the code
      - name: Checkout code ğŸ›ï¸
        uses: actions/checkout@v2
        
      # create a branch
      - name: Create branch and push ğŸŒ¿ğŸ‘†
        run: |
          git checkout production
          git pull origin production
          git checkout -b "bug-${{ github.event.issue.number }}"
          git push origin "bug-${{ github.event.issue.number }}"

      # print
      - name: Completed!! ğŸ‰
        run: echo Successfully Created a Branch! ğŸŠ

  merge-bug-branch:
    runs-on: ubuntu-latest
    # runs if the issue is closed
    if: github.event_name == 'issues' && github.event.action == 'closed'
    steps:
    
      # checkout the code
      - name: Checkout code ğŸ›ï¸
        uses: actions/checkout@v2
      
      # check if the branch exists
      - name: Check if branch exists in remote ğŸ¤”
        run: |
          if git ls-remote --heads origin "bug-${{ github.event.issue.number }}" | grep -q "bug-${{ github.event.issue.number }}"; then
            echo "Branch exists in remote! ğŸŒ"
          else
            echo "Branch does not exist in remote! âŒ"
            exit 1
          fi

      # merge branch
      - name: Merge bug branch to dev ğŸŒ¿ğŸ”€
        run: |
          branch_name="bug-${{ github.event.issue.number }}"
          git checkout -b $branch_name
          git merge production
          git push origin $branch_name

      # delete remote branch
      - name: Delete branch ğŸ—‘ï¸
        run: |
          branch_name="bug-${{ github.event.issue.number }}"
          git branch -d $branch_name
          git push --delete origin $branch_name

      # print
      - name: Completed!! ğŸ‰
        run: echo Successfully Merged the Branch! ğŸŠ
