# A Github Workflow to Organize Bug Issues with Branch
# -----------------------------
# It will:
# - will create a branch "bug-{issue_id}" when a issue with `bug` label is created, or issue is labeled.
# - will merge the branch "bug-{issue_id}" when issue is closed.
# -----------------------------
# Owner: kyleperison915
# Author: rakeshchow202@fiverr [ fiverr.com/users/rakeshchow202 ] / github.com/CypherpunkSamurai

name: Create Bug Branch ğŸ›ğŸŒ¿

on:
  issues:
    types: [labeled, opened, closed]
    # Filter for issues labeled with "bug"
    # or issues with the word "bug" in the title or body
    # using a regular expression
    # (https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context)

# tasks
jobs:
  create-branch:
    runs-on: ubuntu-latest
    # run if issue was labeled or created
    if: contains(github.event.issue.labels.*.name, 'bug') && github.event_name == 'issues' && (github.event.action == 'labeled' || github.event.action == 'opened')
    steps:

      # checkout the code
      - name: Checkout code ğŸ›ï¸
        uses: actions/checkout@v2
        
      # create a branch
      - name: Create branch and push ğŸŒ¿ğŸ‘†
        run: |
          git checkout production
          git pull origin production
          git checkout -b "bug-${{ github.event.issue.number }}"
          git push origin "bug-${{ github.event.issue.number }}"

      # print
      - name: Completed!! ğŸ‰
        run: echo Successfully Created a Branch! ğŸŠ

  merge-bug-branch:
    runs-on: ubuntu-latest
    # runs if the issue is closed
    if: contains(github.event.issue.labels.*.name, 'bug') && github.event_name == 'issues' && (github.event.action == 'closed')
    steps:
    
      # checkout the code
      - name: Checkout code ğŸ›ï¸
        uses: actions/checkout@v2
      
      # check if the branch exists
      - name: Check if branch exists in remote ğŸ¤”
        run: |
          if git ls-remote --heads origin "bug-${{ github.event.issue.number }}" | grep -q "bug-${{ github.event.issue.number }}"; then
            echo "Branch exists in remote! ğŸŒ"
          else
            echo "Branch does not exist in remote! âŒ"
            exit 1
          fi

      # merge branch
      - name: Merge bug branch to dev ğŸŒ¿ğŸ”€
        run: |
          branch_name="bug-${{ github.event.issue.number }}"
          git checkout -b $branch_name
          git merge production
          git push origin $branch_name

      # delete remote branch
      - name: Delete branch ğŸ—‘ï¸
        run: |
          git branch -d $branch_name
          git push --delete origin $branch_name

      # print
      - name: Completed!! ğŸ‰
        run: echo Successfully Merged the Branch! ğŸŠ
